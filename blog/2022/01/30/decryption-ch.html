<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.2.1 <https://hydejack.com/>
--><head><title>Breaking decryption.ch: the CTF that wasn't meant to be |</title><meta name="description" content="This article is a write up regarding the challenge published on decryption.ch by the Ex0-Sys company. Even if I resolved it in 2019, it took me a bit of time and motivation to write and finalize that blog post. Better late than never, as they say. "><link rel="canonical" href="https://aguinet.github.io/blog/2022/01/30/decryption-ch.html"><meta name="color-scheme" content="light"><meta name="theme-color" content="rgb(0,0,0)"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content=""><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="application-name" content=""><meta name="generator" content="Hydejack v9.2.1" /><link rel="alternate" href="https://aguinet.github.io/blog/2022/01/30/decryption-ch.html" hreflang="en"><link type="application/atom+xml" rel="alternate" href="https://aguinet.github.io/feed.xml" title="" /><link rel="shortcut icon" href="/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"> <script>((r,a)=>{function d(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=a.createElement("script"),e=(n.src=e,t&&d(n,"load",t,{once:!0}),a.scripts[0]);return e.parentNode.insertBefore(n,e),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=a.createElement("script");function o(){r._loaded=!0,t&&d(n,"load",t,{once:!0});var e=a.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():d(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){d(a.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}})(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/'; w._publicPath = '/assets/js/'; w._noPushState = false; w._noDrawer = true; w._noNavbar = true; w._noToc = false; w._noSearch = false; w._search = { DATA_URL: '/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/', INDEX_KEY: 'index--2025-09-28T16:42:06+02:00', }; w._clapButton = false; }(window);</script> <script async src="/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----><style id="_styleInline"> .clearfix,.sidebar-social::after{content:"";display:table;clear:both}.color-transition,.content .avatar,.nav-btn,.nav-btn-bar,.navbar,.message,.note-sm,#markdown-toc,.note,.hr-bottom,.hr-after::after,hr,.hr,p,body{transition:none}#_dark-mode{font-size:1.25rem}@media screen{body,body.light-mode{--body-color: #333;--body-bg: #fff;--border-color: #ebebeb;--gray: #777;--gray-bg: rgba(0, 0, 0, 0.025);--gray-text: #666;--menu-text: #bbb;--inv-body-color: #ccc;--inv-body-bg: var(--dark-mode-body-bg)}body .content,body.light-mode .content{-webkit-font-smoothing:initial;-moz-osx-font-smoothing:initial}body.dark-mode{--body-color: #ccc;--body-bg: var(--dark-mode-body-bg);--border-color: var(--dark-mode-border-color);--gray: rgba(255,255,255,.5);--gray-bg: rgba(255,255,255,.033);--gray-text: rgba(255,255,255,.625);--menu-text: rgba(255,255,255,.25);--inv-body-color: #333;--inv-body-bg: #fff}body.dark-mode .content{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}}html{--font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, Arial, sans-serif;--font-family-heading: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, Arial, sans-serif;--code-font-family: ui-monospace, Menlo, Monaco, Cascadia Mono, Segoe UI Mono, Roboto Mono, Oxygen Mono, Ubuntu Mono, Source Code Pro, Fira Mono, Droid Sans Mono, Consolas, Courier New, monospace;--root-font-size: 15px;--root-font-size-medium: 16px;--root-font-size-large: 17px;--root-font-size-print: 8pt;--root-line-height: 1.75;--font-weight: 400;--font-weight-bold: 700;--font-weight-heading: 900;--content-width-5: 54rem;--content-margin-5: 4rem;--sidebar-width: 21rem;--half-content: 31rem;--break-point-3: 64em;--break-point-5: 86em;--break-point-dynamic: 104rem}*{box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:var(--font-family);font-size:var(--root-font-size);line-height:var(--root-line-height)}body{color:var(--body-color);background-color:var(--body-bg);font-weight:var(--font-weight);overflow-y:scroll}.content img,.img,.content video,.video{max-width:100%;height:auto}.lead{margin-left:-1rem;margin-right:-1rem;margin-bottom:1.5rem}img.lead,video.lead{display:block;max-width:calc(100% + 2rem);width:calc(100% + 2rem);height:auto}.heading,.f6,h6,.h6,.f5,h5,.h5,.f4,.sidebar-nav-item,h4,.h4,.post-date,.f3,h3,.h3,.f2,h2,.h2,.f1,h1,.h1{font-family:var(--font-family-heading);font-weight:var(--font-weight-heading)}.f1,h1,.h1{font-size:2rem;line-height:1.3}.f2,h2,.h2{font-size:1.5rem;line-height:1.4}.f3,h3,.h3{font-size:1.2em;line-height:1.5}.f4,.sidebar-nav-item,h4,.h4,.post-date{font-size:1.08rem;line-height:1.6}.f5,h5,.h5{font-size:1.04rem;line-height:1.7}.f6,h6,.h6{font-size:1rem}.content h1>a,.content .h1>a{text-decoration:none;border-bottom:none}@media screen and (max-width: 42em){.content h1,.content .h1{font-size:1.7rem;line-height:1.35}}@media screen and (min-width: 86em){.content h1,.content .h1{font-size:2.4rem;line-height:1.25}}@media screen and (min-width: 104rem){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{width:calc(100% + 50vw - 32rem);font-size:3rem;line-height:1.2}}@media screen and (min-width: 124em){body:not(.no-large-headings) .content h1,body:not(.no-large-headings) .content .h1{font-size:4rem;line-height:1.1}}h1,h2,h3,.h1,.h2,.h3{margin:4rem 0 1rem}h4,h5,h6,.h4,.post-date,.h5,.h6{margin:3rem 0 .5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.2em;margin-top:1.5rem;margin-bottom:1.5rem;padding:0 1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}ul,ol{padding-left:1.25rem}hr,.hr{border:0;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-after::after{content:"";display:block;margin:1rem 0;border-top:1px solid var(--border-color)}.hr-bottom{border-bottom:1px solid var(--border-color);padding-bottom:.75rem;margin-bottom:1rem}.page{margin-bottom:3em}.page li+li{margin-top:.25rem}.page>header{position:relative;margin-bottom:2rem}@media screen and (min-width: 104rem){body:not(.no-third-column) .page>header>.lead+.note-sm,body:not(.no-third-column) .page>header>.lead+#markdown-toc,body:not(.no-third-column) .page>header>.lead+.note,body:not(.no-third-column) .page>header>a.no-hover+.note-sm,body:not(.no-third-column) .page>header>a.no-hover+#markdown-toc,body:not(.no-third-column) .page>header>a.no-hover+.note{position:absolute;right:-25rem;width:21rem;bottom:0;margin-bottom:0}}.page-title,.post-title{margin-top:0}.post-date{display:flex;justify-content:space-between;margin-top:-0.6rem;height:2rem;margin-bottom:.85rem;color:var(--gray)}.post-date>.ellipsis,.post-date#breadcrumbs>ul{cursor:pointer}.post-date [class^=icon-]{display:inline-block;font-size:smaller;margin-right:.25rem}.related-posts{padding-left:0;list-style:none;margin-bottom:2rem}.related-posts>li,.related-posts>li+li{margin-top:1rem}.message,.note-sm,#markdown-toc,.note{margin-bottom:1rem;padding:1rem;color:var(--gray-text);background-color:var(--gray-bg);margin-left:-1rem;margin-right:-1rem}.note-sm,#markdown-toc,.note{background:rgba(0,0,0,0);color:var(--body-color);font-size:smaller;border-left:1px solid var(--border-color);padding:1.2rem 1rem 0 1rem;margin:1rem -1rem;position:relative}.note-sm:before,#markdown-toc:before,.note:before{font-size:.667rem;font-weight:bold;font-style:normal;letter-spacing:.025rem;text-transform:uppercase;color:var(--menu-text);position:absolute;top:0}.note-sm[title]:before,[title]#markdown-toc:before,[title].note:before{content:attr(title) !important}.note{font-size:1rem}@media screen{body::before{content:"";width:.5rem;background:var(--gray-bg);position:fixed;left:0;top:0;bottom:0}}@media(min-width: 64em){body::before{width:21rem}}@media(min-width: 104rem){body::before{width:calc(50% - 31rem)}}@media screen and (min-width: 42em){html{font-size:var(--root-font-size-medium)}}@media screen and (min-width: 124em){html{font-size:var(--root-font-size-large)}}#breadcrumbs>ul{height:1rem;margin:-1.5rem 0 .5rem;padding:0;font-size:.667rem;color:var(--menu-text);text-transform:uppercase;width:100%;list-style:none}#breadcrumbs>ul>li{display:inline}#breadcrumbs>ul>li a{color:var(--gray);text-decoration:none;border-bottom:none}.fl{float:left}.fr{float:right}.mb4{margin-bottom:4rem}.mb6{margin-bottom:6rem}.mt0{margin-top:0}.mt1{margin-top:1rem}.mt2{margin-top:2rem}.mt3{margin-top:3rem}.mt4{margin-top:4rem}.pb0{padding-bottom:0}.ml1{margin-left:1rem}.mr1{margin-right:1rem}.sixteen-nine{position:relative}.sixteen-nine::before{display:block;content:"";width:100%;padding-top:56.25%}.sixteen-nine>*{position:absolute;top:0;left:0;right:0;bottom:0}.sixteen-ten{position:relative}.sixteen-ten::before{display:block;content:"";width:100%;padding-top:62.5%}.sixteen-ten>*{position:absolute;top:0;left:0;right:0;bottom:0}.four-three{position:relative}.four-three::before{display:block;content:"";width:100%;padding-top:75%}.four-three>*{position:absolute;top:0;left:0;right:0;bottom:0}.sr-only{display:none}.larger{font-size:larger}.smaller{font-size:smaller}.clearfix,.sidebar-social::after{content:"";display:table;clear:both}.ellipsis,#breadcrumbs>ul{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.border{border:1px solid var(--border-color)}@media(min-width: 42em){.border-radius,.lead,.page .aspect-ratio.sixteen-nine.lead{border-radius:.5rem}}.fallback-img{background-position:center;background-repeat:no-repeat;background-image:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuMDQ4ODI4LCAwLCAwLCAwLjA0Nzk5MSwgNTQuOTk5OTczLCAyMC40MjgxNDgpIj4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTk1OS44ODQgMTI4YzAuMDQwIDAuMDM0IDAuMDgyIDAuMDc2IDAuMTE2IDAuMTE2djc2Ny43N2MtMC4wMzQgMC4wNDAtMC4wNzYgMC4wODItMC4xMTYgMC4xMTZoLTg5NS43N2MtMC4wNDAtMC4wMzQtMC4wODItMC4wNzYtMC4xMTQtMC4xMTZ2LTc2Ny43NzJjMC4wMzQtMC4wNDAgMC4wNzYtMC4wODIgMC4xMTQtMC4xMTRoODk1Ljc3ek05NjAgNjRoLTg5NmMtMzUuMiAwLTY0IDI4LjgtNjQgNjR2NzY4YzAgMzUuMiAyOC44IDY0IDY0IDY0aDg5NmMzNS4yIDAgNjQtMjguOCA2NC02NHYtNzY4YzAtMzUuMi0yOC44LTY0LTY0LTY0djB6Ii8+CiAgICA8cGF0aCBzdHlsZT0iZmlsbDpyZ2JhKDEyOCwxMjgsMTI4LC4zMykiIGQ9Ik04MzIgMjg4YzAgNTMuMDIwLTQyLjk4IDk2LTk2IDk2cy05Ni00Mi45OC05Ni05NiA0Mi45OC05NiA5Ni05NiA5NiA0Mi45OCA5NiA5NnoiLz4KICAgIDxwYXRoIHN0eWxlPSJmaWxsOnJnYmEoMTI4LDEyOCwxMjgsLjMzKSIgZD0iTTg5NiA4MzJoLTc2OHYtMTI4bDIyNC0zODQgMjU2IDMyMGg2NGwyMjQtMTkyeiIvPgogIDwvZz4KPC9zdmc+")}hy-push-state a{color:var(--body-color)}@supports not ((text-decoration-thickness: initial) and (text-underline-offset: initial)){hy-push-state a{text-decoration:none;border-bottom:2px solid}}@supports(text-decoration-thickness: initial) and (text-underline-offset: initial){hy-push-state a{text-decoration-style:solid;text-underline-offset:.35rem;text-decoration-thickness:2px}}hy-push-state a.no-hover{border-bottom:none;text-decoration-thickness:unset;text-underline-offset:unset}@supports(text-decoration-thickness: initial) and (text-underline-offset: initial){.content a:not(.btn):not(.no-hover){text-decoration-color:var(--accent-color-faded)}}.content a:not(.btn):not(.no-hover){border-color:var(--accent-color-faded)}.content .aspect-ratio{overflow:hidden}.content .aspect-ratio img{margin:0;width:100%;height:100%;background-color:var(--gray-bg)}hy-drawer{width:100%;position:relative;overflow:hidden;display:block;z-index:4}@media screen and (min-width: 64em){hy-drawer{position:fixed;width:21rem;top:0;left:0;bottom:0;margin-left:0}hy-drawer.cover{position:relative;width:100%}}@media screen and (min-width: 104rem){hy-drawer{width:calc(50% - 31rem)}}.sidebar{position:relative;display:flex;justify-content:center;align-items:center;color:hsla(0,0%,100%,.75);text-align:center;min-height:100vh}.sidebar.invert{color:rgba(32,32,32,.75)}.sidebar a{color:#fff;border-bottom-color:hsla(0,0%,100%,.2);text-decoration-color:hsla(0,0%,100%,.2)}.sidebar.invert a{color:#222;border-bottom-color:rgba(32,32,32,.2);text-decoration-color:rgba(32,32,32,.2)}.sidebar-bg{position:absolute;top:0;left:calc(50% - 50vw);width:100vw;height:100%;background:#202020 center/cover}.sidebar-bg::after{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,.05)}.sidebar-bg.sidebar-overlay::after{background:linear-gradient(to bottom, rgba(32, 32, 32, 0) 0%, rgba(32, 32, 32, 0.5) 50%, rgba(32, 32, 32, 0) 100%)}.sidebar-sticky{position:relative;z-index:3;max-width:21rem;padding:1.5rem;contain:content}.sidebar-about .avatar{margin-bottom:1.5rem}.sidebar-about>a.sidebar-title{text-decoration:none}.sidebar-about>a.sidebar-title>h2{margin:0;padding-bottom:.5rem}.sidebar-about>a.sidebar-title::after{content:"";display:block;border-bottom:2px solid;margin:0 auto .5rem;width:4rem;border-color:hsla(0,0%,100%,.2);transition:border-color 250ms}.sidebar-about>a.sidebar-title:hover::after{border-color:#fff;transition:border-color 50ms}.sidebar.invert .sidebar-about>a.sidebar-title::after{border-color:rgba(32,32,32,.2)}.sidebar.invert .sidebar-about>a.sidebar-title:hover::after{border-color:#222}.sidebar-nav>ul{list-style:none;padding-left:0}.sidebar-nav-item{display:inline-block;margin-bottom:.5rem}@media(min-width: 64em){#_main.no-drawer #_menu{display:none}#_main.no-drawer .nav-btn-bar>:nth-child(2){border:none}}.sidebar-social>ul{display:inline-block;list-style:none;padding-left:0;margin-bottom:0}.sidebar-social>ul>li{float:left}.sidebar-social>ul>li>a{display:inline-block;text-align:center;font-size:1.4rem;width:3rem;height:4rem;padding:.5rem 0;line-height:3rem;text-decoration:none;border-bottom-width:2px;border-bottom-style:solid}.sidebar-social>ul li+li{margin-top:0}.fixed-common,.fixed-bottom,.fixed-top{position:fixed;left:0;width:100%;z-index:2}.fixed-top{top:0}.fixed-bottom{bottom:0}.navbar>.content{position:relative;padding-top:0;padding-bottom:0;min-height:0;max-height:5rem}.nav-btn-bar{margin:0 -1rem;background-color:#fff;background-color:var(--body-bg);height:5rem;display:flex;align-items:center;position:relative}.nav-btn-bar>:first-child,.nav-btn-bar>:last-child{border:none}.nav-btn{background:none;border:none;text-decoration:none;display:flex;align-items:center;justify-content:center;width:3.25rem;height:5rem;color:var(--menu-text);border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);margin-left:-1px}#markdown-toc{margin:2rem -1rem 2rem calc(-1rem + 1px);padding-left:2.5rem;padding-bottom:.5rem}#markdown-toc:before{left:1rem}@media screen and (min-width: 104rem){body:not(.no-toc) #markdown-toc{position:absolute;z-index:4;width:20.5rem;right:0;margin:auto;overflow:auto}}@media screen and (min-width: 104rem){body.no-break-layout:not(.no-toc) #markdown-toc{width:calc(50% - 31rem)}}.content{margin-left:auto;margin-right:auto;padding:8rem 1rem 12rem}@media screen{.content{padding-left:1.5rem;min-height:100vh}}@media screen and (min-width: 42em){.content{max-width:42rem}}@media screen and (min-width: 54em){.content{max-width:48rem}}@media screen and (min-width: 64em){.content{padding-left:1rem;margin-left:24rem;margin-right:3rem}}@media screen and (min-width: 86em){.content{padding-top:9rem;margin-left:25rem;margin-right:4rem;max-width:54rem}}@media screen and (min-width: 104rem){.content{margin:auto}}.large-only{display:none}@media screen and (min-width: 104rem){.large-only{display:block}}.avatar{width:7rem;height:7rem;border-radius:100%;overflow:hidden;display:inline-block}.avatar img{width:100%}.content .avatar{float:right;box-sizing:content-box;border:1rem solid var(--body-bg);transition:border-color 1s ease;margin-top:-1.5rem;margin-right:-1rem}.center-image{margin:0 auto;display:block}.note:before{content:"Note"}.page>header>.note-sm:before,.page>header>.note:before,.page>header>#markdown-toc:before{content:"Description"}#markdown-toc:before{content:"Table of Contents"}.layout-resume .note-sm:before,.layout-resume .note:before,.layout-resume #markdown-toc:before{content:"Summary"}</style><link rel="preload" as="style" href="/assets/css/hydejack-9.2.1.css" id="_stylePreload"><link rel="preload" as="style" href="/assets/icomoon/style.css" id="_iconsPreload"> <script> setRel('_stylePreload'); setRel('_iconsPreload'); /**/ </script> <noscript><link rel="stylesheet" href="/assets/css/hydejack-9.2.1.css"><link rel="stylesheet" href="/assets/icomoon/style.css"> </noscript><style id="_pageStyle"> html{--accent-color: rgb(0,0,0);--accent-color-faded: rgba(0, 0, 0, 0.5);--accent-color-highlight: rgba(0, 0, 0, 0.1);--accent-color-darkened: black;--theme-color: rgb(0,0,0);--dark-mode-body-bg: hsl(0, 0%, 17.5%);--dark-mode-border-color: hsl(0, 0%, 22.5%)}</style><!--<![endif]--><body class="no-break-layout no-drawer"> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange ><main id="_main" class="content layout-post" role="main" ><nav id="breadcrumbs" class="screen-only"><ul><li><a href="/">home</a><li> <span>/</span> <a href="/blog/">blog</a><li> <span>/</span> <a href="/blog/2022/">2022</a><li> <span>/</span> <a href="/blog/2022/01/">01</a><li> <span>/</span> <a href="/blog/2022/01/30/">30</a><li> <span>/</span> <span>decryption-ch.html</span></ul></nav><article id="post-blog-2022-01-30-decryption-ch" class="page post mb6" role="article"><header><h1 class="post-title flip-project-title"> Breaking decryption.ch: the CTF that wasn't meant to be</h1><div class="post-date"> <span class="ellipsis mr1"> <time datetime="2022-01-30T00:00:00+01:00">30 Jan 2022</time> in <span>Blog</span> </span></div><div class="hr pb0"></div></header><p>This article is a write up regarding the challenge published on <a href="https://decryption.ch">decryption.ch</a> by the <a href="https://ex0-sys.com/">Ex0-Sys</a> company. Even if I resolved it in 2019, it took me a bit of time and motivation to write and finalize that blog post. Better late than never, as they say.<p>Anyway, this post describes how the challenge has been broken, from reverse engineering the software to actually decrypting the provided <em>secure</em> container.<p>The source code that breaks the challenge is <a href="https://github.com/aguinet/alphatav">available on Github</a>.<p class="figure"><img src="/assets/2022-01-30-decryption-ch/bounty.jpg" alt="" class="center-image" /> A screenshot of the <a href="https://decryption.ch">decryption.ch</a> web site<h1 id="the-alphatav-software">The AlphaTav software</h1><p>The challenge is about assessing the cryptography strength of the <a href="https://alpha-tav-vault.com">AlphaTav software</a>. This software claims various security properties:<ul><li>being quantum resistant<li>time limitation<li>destruction on bad credentials<li>computer hardware restriction (based on a technology named <a href="https://www.alpha-tav-vault.com/documentation/#uid">Ex0-UiD</a>)<li>final encryption key up to 87000 bits<li>over encryption with <em>conventional</em> algorithms (AES256/3DES/RC2)</ul><p>Some of these properties (like time limitation &amp; destruction on bad credentials) are “enforced” by the AlphaTav client itself. As you might imagine, this holds as long as you don’t have any other code that would implement the same algorithm.<p>Moreover, the AlphaTav software has multiple particularities that need to be defined in order to make the rest of the writeup easier to follow:<ul><li>a container is separated into four files:<ul><li><code class="language-plaintext highlighter-rouge">ATK3</code>: a file that contains settings (e.g. used algorithms, time restriction &amp; so on) and some key material<li><code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code>/<code class="language-plaintext highlighter-rouge">ATK2</code>: encrypted data split in three parts</ul><li>multiple raw key materials: password &amp; PIN code.<li>multiple levels of security:<ul><li><a href="https://www.alpha-tav-vault.com/documentation/#level1">level 1</a>: only the <a href="#the-fragmentation-algorithm-atdatk1atk2">fragmentation algorithm</a> is used to “encrypt” <sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> data.<li><a href="https://www.alpha-tav-vault.com/documentation/#level2">level 2</a>: level 1 with a random “PIN code” (see below) as key material <sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup><li><a href="https://www.alpha-tav-vault.com/documentation/#level3">level 3</a>: level 2, with an additional user password as key material</ul></ul><p>Surprisingly enough, and as we will see in the sections below, the Exo-UID isn’t used as key material and is just a test performed by the decryption process that verifies that the expected hardware is present (see previous remark on time limit). Moreover:<ul><li>the PIN code is a 16-byte random buffer saved as a bar code. It is generated by the software when encrypting, and is needed to decrypt.<li>the password is optional and provided by the user.</ul><p>We’ll discuss the various claims in the following sections. Let’s now take a look at the actual challenge.<h1 id="the-challenge-material">The challenge material</h1><p>We are provided with:<ul><li>a 460MB container encrypted with:<ul><li>Vault level 3 (4 files, PIN code, password)<li>Hardware restrictions (4 USB keys + various computers)<li>Time limitation<li>Destruction on bad credentials</ul><li>the AlphaTav version used to make this container, as a Windows installer<li>a free 30 days licence on demand</ul><p>What we <strong>don’t</strong> have:<ul><li>The password used to encrypt this container<li>The generated PIN-code</ul><p>If we manage to decrypt the container, we are supposed to find a video with the instructions to validate the challenge.<h1 id="methodology">Methodology</h1><p>So we have to crack an encrypted container, without the raw key material that was used to create it, and without a description of the proprietary algorithm that has been used. The methodology I use for these cases is somehow always the same:<ul><li>reverse engineer the application to understand the underlying algorithms and/or file formats<li>reimplement an encryption and/or decryption tool it in a language that allows fast prototyping and provides a cryptography toolbox with the usual primitives (in this case Python has been used)<li>create a container similar to the one of the challenge, but whose original content is known (can help figuring out implementation errors)<li>emit hypothesis about potential cryptographic vulnerabilities<li>play with our implementation and container to prototype attacks and (in)validate the previous hypothesis<li>repeat until it works, or until we can demonstrate that it will require a bruteforce we won’t be able to perform</ul><p>In this case, I started to understand the decryption routine, but doing so with the encryption one would also work. Per design, you should be able to derive one from the other.<p>One of the hardest part in this is the reverse engineering job to create a third party implementation we can toy with. We need to be rigorous here, as a minor mistake in the algorithm reversing/implementation can be hard to detect and cause potentially valid attacks to fail. One way to make this not too much of a pain is to extract as much test vectors as possible from the original application for every step of the algorithm (e.g. using a debugger), and use these vectors to validate our custom implementation.<p>So let’s go through all these steps!<h1 id="reverse-engineering">Reverse engineering</h1><p>The only thing in our possession to figure out the encryption algorithm(s) is the AlphaTav software, which is an obfuscated .Net application. We can also gather public information about what is supposed to happen at least on a high level view:<p><img src="/assets/2022-01-30-decryption-ch/official_workflow.jpg" alt="" class="center-image" /><h2 id="deobfuscation--debugging">Deobfuscation / debugging</h2><p>In order to do a first static analysis, we used the very efficient <a href="https://github.com/0xd4d/de4dot">de4dot</a> software, which can deobfuscate a large variety of protectors.<p>Fortunately for us, <a href="https://github.com/0xd4d/de4dot">de4dot</a> detects that the AlphaTav software has been obfuscated with CryptoObfuscator… twice. Indeed, some libraries also have to be deobfuscated again, still using <a href="https://github.com/0xd4d/de4dot">de4dot</a>.<p>What’s nice about this tool is that it can generate a proper binary that just runs. So we can now use <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> to debug and analyze the software.<p>Now that we are in a more comfortable position, our main goal was to follow two <em>data flows</em>: the one that starts from clear data to encrypted data, and the one that starts from raw key material (the password / PIN code) to whatever derivations might happen, all towards the convergence of these two <em>flows</em> to the final encrypted data.<h2 id="the-decryption-algorithm">The decryption algorithm</h2><p>After tedious reading of .Net code, and some debugging session to be sure everything was correctly understood, here is a scheme of the decryption algorithm as understood after reverse engineering:<p><img src="/assets/2022-01-30-decryption-ch/decrypt_algo.svg" alt="" class="center-image" /><p>This is a bit huge, so let’s discuss the various parts of this algorithm.<h3 id="the-fragmentation-algorithm-atdatk1atk2">The fragmentation algorithm (<code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code>/<code class="language-plaintext highlighter-rouge">ATK2</code>)</h3><p>The AlphaTav fragmentation algorithm is an encoding process that splits a byte into three different values. In the AlphaTav software, each of these values are stored in different files:<ul><li>AlphaTav (<code class="language-plaintext highlighter-rouge">AT</code>), stored in <code class="language-plaintext highlighter-rouge">ATK1</code><li>Block sizes (<code class="language-plaintext highlighter-rouge">BS</code>), stored in <code class="language-plaintext highlighter-rouge">ATK2</code>. This file <strong>is not encrypted</strong>.<li>Bit indexes (<code class="language-plaintext highlighter-rouge">BI</code>), stored in <code class="language-plaintext highlighter-rouge">ATD</code></ul><p>Here is a Python code describing how an 8-bit value is encoded:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EncodedData</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="nc">BitCount</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">AT</span> <span class="o">=</span> <span class="p">(</span><span class="n">BC</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">BC</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">BC</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">V</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="ow">or</span> <span class="n">V</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">BS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">BS</span> <span class="o">=</span> <span class="n">BC</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">AT</span> <span class="nf">else </span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="n">BC</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">BI</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">V</span> <span class="o">!=</span> <span class="mh">0xFF</span> <span class="ow">and</span> <span class="n">V</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">reversed</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
                <span class="nf">if </span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">AT</span><span class="p">)</span> <span class="o">==</span> <span class="n">b</span><span class="p">):</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">BI</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">BI</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
</code></pre></div></div><p>And a few examples:<table><thead><tr><th>V<th>bin(V)<th>Bit count<th>AT<th>BS<th>BI<tbody><tr><td>0x07<td>0b00000111<td>3<td>1<td>3<td>567<tr><td>0xAF<td>0b10101111<td>6<td>0<td>2<td>13<tr><td>0x2F<td>0b00101111<td>5<td>0<td>3<td>13<tr><td>0x00<td>0b00000000<td>0<td>0<td>0<td>0<tr><td>0xFF<td>0b11111111<td>8<td>1<td>0<td>0</table><p>Some points worth mentioning for what’s next:<ul><li><code class="language-plaintext highlighter-rouge">AT</code> is just one bit wide, and is stored as a bitstream in ATK1<li><code class="language-plaintext highlighter-rouge">BS</code> is basically the number of bits at one or zero, depending on <code class="language-plaintext highlighter-rouge">AT</code> (except for <code class="language-plaintext highlighter-rouge">0x00</code> and <code class="language-plaintext highlighter-rouge">0xFF</code>). It is stored as packed 4 bit numbers.<li><code class="language-plaintext highlighter-rouge">BI</code> is basically a base 10 encoding of the bits that are at one or zero (depending on AT)</ul><p>Moreover, as you can see in the table above, the <code class="language-plaintext highlighter-rouge">BI</code> value can be bigger than one byte. That being said, there is only 99 possible different values (run <code class="language-plaintext highlighter-rouge">len(set(EncodedData(v).BI for v in range(256)))</code> to convince yourself). We can thus encode this value on one byte, with a fixed substitution table to recover the original value. Such a table is included in the AlphaTav software. The important thing to remember here is that the MSB bit of an encoded <code class="language-plaintext highlighter-rouge">BI</code> value will always be zero. This will be very important for what’s next.<h3 id="the-atk3-file">The ATK3 file</h3><p>This file is actually a TIFF image. It contains mainly two things:<ul><li><p>inside its copyright metadata: encryption key material used in various key derivation process. The actual key used for the AES/3DES/RC2 algorithm is derived from these information. The important point here is that no user key material is necessary to compute this key.<li><p>encoded inside the value of its green pixels (!): a serialized .Net object containing information about the encryption algorithm used for <code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code>/<code class="language-plaintext highlighter-rouge">ATK2</code>. It also contains the various “restrictions”. This is encrypted with key material derived from the copyright metadata above, so we are always able to decrypt it.</ul><p>Using a serialized .Net object doesn’t seem the best choice for interoperability with non .Net platforms, and might also be <a href="https://github.com/pwntester/ysoserial.net">a security risk</a>.<p>Moreover, as we just said, deserializing a .Net object from something else than a .Net virtual machine is not that trivial. I’ve built a <a href="https://construct.readthedocs.io/en/latest/">construct</a>-based python module for this, that does not support the whole format, but is enough for the need of this challenge: <a href="https://github.com/aguinet/dotnetDeser">dotnetDeser</a>.<h3 id="keystream-derivation-process">Keystream derivation process</h3><p>What is called “keystream” is a fixed amount of bytes that is generated out of many information, thanks to a <a href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> function:<ul><li>the user password (if used any)<li>the PIN code<li>additional restriction information (e.g. hardware ones), that you can just gather from <a href="#the-atk3-file">ATK3</a></ul><p>The length of this keystream depends on the length <code class="language-plaintext highlighter-rouge">L</code> of the user password. The formula is <code class="language-plaintext highlighter-rouge">#(KS) = clamp(100*L, 1024, 131072)</code>.<p>The user password and PIN code, among with information extracted from <a href="#the-atk3-file">ATK3</a>, are used to generate something called a “factor table”. We don’t really need to understand that part to crack the challenge, so it will be left aside for the sake of consistency.<p>This factor table, along with the additional restriction, are all mixed together through a PBDKF2 function to finally generate the keystream. It is interesting to note that a first version that I have reversed directly used the “factor table” as a keystream (and that’s why the keystream is still called “factor table” in various places of the PoC code).<p>Obviously, in these information, we don’t have the user password and the PIN code, so no direct way to regenerate that keystream.<p>It is also important to notice that, once we have this keystream, we can fully retrieve the encrypted zip. Indeed, it gives the IV for the AES/3DES/RC2 algorithms, and their key is already known thanks to <a href="#the-atk3-file">ATK3</a>.<h1 id="the-cracking-algorithm">The cracking algorithm</h1><h2 id="keystream-reuse-and-retrieval">Keystream reuse and retrieval</h2><p>That being said, the main vulnerability in this design is that this <strong>fixed length</strong> keystream is reused multiple times to XOR data, and not only inside the same file, but also accross <code class="language-plaintext highlighter-rouge">ATD</code> &amp; <code class="language-plaintext highlighter-rouge">ATK1</code> (<code class="language-plaintext highlighter-rouge">ATK2</code> isn’t XORed with this keystream).<p>Let’s take a closer look at how this keystream is used:<p><img src="/assets/2022-01-30-decryption-ch/decrypt_algo_ks.svg" alt="" class="center-image" /><p>Before trying to exploit known clear text to recover that keystream, we need to be able to decrypt and <em>ungzip</em> <code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code>/<code class="language-plaintext highlighter-rouge">ATK2</code>. According to our scheme, they are encrypted using either AES, 3DES or RC2 in CBC mode. The key is known (derived from information in <a href="#the-atk3-file">ATK3</a>), but the IV is unknown, as it is the first bytes of the keystream we are trying to recover. But let’s take a look at how CBC work:<p class="figure"><img src="/assets/2022-01-30-decryption-ch/CBC_decr.svg" alt="" class="center-image" /> From <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher_block_chaining_(CBC)">Wikipedia</a><p>Not knowing the IV only makes the first block unavailable. In the case of AES, it is thus 16 bytes. In the case of 3DES or RC2, it is 8 bytes. Now, let’s take a look at what a GZip file looks like, to see what we lose:<p class="figure"><img src="/assets/2022-01-30-decryption-ch/gzip.svg" alt="" class="center-image" /> Scheme by <a href="https://github.com/corkami">Corkami</a><p>In our cases, the first 8 bytes are, for instance:<ul><li><code class="language-plaintext highlighter-rouge">1F 8B</code>: header<li><code class="language-plaintext highlighter-rouge">08</code>: use DEFLATE (always the case)<li><code class="language-plaintext highlighter-rouge">00</code>: no flags (so no filename)<li><code class="language-plaintext highlighter-rouge">66 59 59 3A</code>: timestamp (we don’t care)</ul><p>So, if <code class="language-plaintext highlighter-rouge">ATD</code>, <code class="language-plaintext highlighter-rouge">ATK1</code> or <code class="language-plaintext highlighter-rouge">ATK2</code> is encrypted using 3DES or RC2, then we can fully decompress the underlying DEFLATE stream. In the case of AES, we miss the first 8 bytes of the actual DEFLATE stream. <a href="#incomplete-gzip-streams">The end of this blog post </a> describes how we can still recover almost all the decompressed data even in this case. Note that, for the actual challenge container, this is not really an issue as none of the files are encrypted with AES (did someone say this was a CTF?).<p>With all these information in mind, let’s formalize a bit the cracking algorithm.<h3 id="hunting-for-known-plaintext">Hunting for known plaintext</h3><p>Let’s consider we are able to ungzip <code class="language-plaintext highlighter-rouge">ATD</code>, <code class="language-plaintext highlighter-rouge">ATK1</code> and <code class="language-plaintext highlighter-rouge">ATK2</code>. The only remaining unknown information is still the <strong>fixed length</strong> keystream (now named <code class="language-plaintext highlighter-rouge">KS</code>). As it is reused within the same file and for <code class="language-plaintext highlighter-rouge">ATD</code> &amp; <code class="language-plaintext highlighter-rouge">ATK1</code> with a XOR operator, knowning the data that has been fed to the <a href="#the-fragmentation-algorithm-atdatk1atk2">fragmentation algorithm</a> will give us known <em>Bit Indexes</em> (<code class="language-plaintext highlighter-rouge">BI</code>) and <em>AlphaTav</em> (<code class="language-plaintext highlighter-rouge">AT</code>) clear values, and hence known bits of <code class="language-plaintext highlighter-rouge">KS</code>. The scheme below describes this attack:<p><img src="/assets/2022-01-30-decryption-ch/attack.svg" alt="" class="center-image" /><p>So let’s hunt for known data!<p>The first thing to notice is that the data that are fed to the <a href="#the-fragmentation-algorithm-atdatk1atk2">fragmentation algorithm</a> are not the actual user files, but an encrypted zip version of them. We don’t need the password of this zip for now, even if it can be derived <a href="#the-zip-password">straight from ATK3</a>. The important parts are:<ul><li>we can guess some known values from the zip format specification<li>it is an encrypted and compress stream, so the values of this zip file can be considered as random ones</ul><h4 id="thanks-to-the-zip-format">Thanks to the zip format</h4><p>Let’s take a look at what a zip file look like:<p class="figure"><img src="/assets/2022-01-30-decryption-ch/zip.svg" alt="" class="center-image" /> Scheme by <a href="https://github.com/corkami">Corkami</a><p>As we can see from this scheme, there are some fixed signatures we can use as known data. This is what we do as a first bootstrap step. In the case of the challenge, this helps recover approximately 12% of the keystream.<h4 id="thanks-to-block-sizes-in-atk2">Thanks to block sizes (in ATK2)</h4><p>If we look carefully at the <a href="##the-decryption-algorithm">decryption scheme</a>, we see that ATK2 isn’t xored with <code class="language-plaintext highlighter-rouge">KS</code>. This means we have direct access to the <em>Block Sizes</em> (<code class="language-plaintext highlighter-rouge">BS</code>) part of the fragmented data. Moreover, one interesting fact of the <a href="#the-fragmentation-algorithm-atdatk1atk2">fragmentation algorithm</a> is that if <code class="language-plaintext highlighter-rouge">BS == 0</code>, then we can have only two original clear values: <code class="language-plaintext highlighter-rouge">0x00</code> or <code class="language-plaintext highlighter-rouge">0xFF</code>. The discrimination is made thanks to the associated <em>AlphaTav</em> (<code class="language-plaintext highlighter-rouge">AT</code>) bit.<p>Coupled with the fact that the fragmented data are the ones of an <a href="#the-decryption-algorithm">encrypted zip stream</a>, it means that the probability of having an original unfragmented value of <code class="language-plaintext highlighter-rouge">0x00</code> or <code class="language-plaintext highlighter-rouge">0xFF</code> is <code class="language-plaintext highlighter-rouge">2/256</code>. For big containers that are a few megabytes, as we have already recovered a few bits from <code class="language-plaintext highlighter-rouge">KS</code> thanks to the zip format (and thus some <code class="language-plaintext highlighter-rouge">AT</code> values), our experiences show we usually manage to figure out enough <code class="language-plaintext highlighter-rouge">0x00</code> or <code class="language-plaintext highlighter-rouge">0xFF</code> original values for the zip stream, and with them what remains of <code class="language-plaintext highlighter-rouge">KS</code>. In the case of the challenge, the container is around 460Mb, so we have plenty of data to run the attack and make it successful.<p>We can also notice that there is some form of “avalanche” effect, due to the fact that <code class="language-plaintext highlighter-rouge">KS</code> is reused repeatedly across the same file, and across <code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code> &amp; <code class="language-plaintext highlighter-rouge">ATK2</code>. Indeed, if we manage to recover at least one new bit of <code class="language-plaintext highlighter-rouge">KS</code> with this technique, it means we might recover new bits of <code class="language-plaintext highlighter-rouge">KS</code> by just rerunning this part of the algorithm from the beginning, and so on. In the case of the challenge, only one run was necessary to fully recover <code class="language-plaintext highlighter-rouge">KS</code> (as this is a relatively big container).<p>We also think there is an interesting math exercise that would compute the probability of success of this attack given the size of the original container (considering the number of already known <code class="language-plaintext highlighter-rouge">KS</code> bits).<h3 id="figuring-out-the-keystream-length">Figuring out the keystream length</h3><p>One thing we didn’t discuss yet is how to find the length of <code class="language-plaintext highlighter-rouge">KS</code>, which is, as a reminder, <code class="language-plaintext highlighter-rouge">#(KS) = clamp(100*L, 1024, 131072)</code> (with <code class="language-plaintext highlighter-rouge">L</code> the length of the user provided password, which is unknown).<p>One interesting thing we have noticed during the analysis of the <a href="#the-fragmentation-algorithm-atdatk1atk2">fragmentation algorithm</a> is that the maximum value for <code class="language-plaintext highlighter-rouge">AT</code> is <code class="language-plaintext highlighter-rouge">99</code>, so the MSB of <code class="language-plaintext highlighter-rouge">AT</code> will <strong>always be 0</strong>. So if we take two different blocks of ATD data of length <code class="language-plaintext highlighter-rouge">N</code> whose index is aligned on <code class="language-plaintext highlighter-rouge">N</code> bytes, and XOR-ing these two blocks gives at least one byte with its MSB equals to 1, it means we have guessed a wrong value for <code class="language-plaintext highlighter-rouge">#(KS)</code>.<p>Moreover, reverse engineering the AlphaTav software shows that the password length <code class="language-plaintext highlighter-rouge">L</code> is between 10 and 1310. So we have 1300 possibilities for <code class="language-plaintext highlighter-rouge">L</code>, and thus for <code class="language-plaintext highlighter-rouge">#(KS)</code> (clamping does not change this), which is easily <em>bruteforcable</em> with this technique.<p>Then, once we have figured out candidates for <code class="language-plaintext highlighter-rouge">#(KS)</code>, we verify that we don’t find any inconsistencies while guessing clear texts. Indeed, if two clear texts at various positions provides two different bits for <code class="language-plaintext highlighter-rouge">KS</code>, it means <code class="language-plaintext highlighter-rouge">#(KS)</code> isn’t valid (considering there are no errors in the guessed clear texts).<p>In practice, we can crack the challenge with the first <code class="language-plaintext highlighter-rouge">L</code> value guessed.<h3 id="the-zip-password">The zip password</h3><p>The zip password is basically a number called <code class="language-plaintext highlighter-rouge">TimeKey</code> stored in the serialized .Net object in <a href="#the-atk3-file">ATK3</a>. It is more precisely the base 8 representation of this number as a string. The important point is that it does not depend on any user supplied key material, and so is always computable given only <a href="#the-atk3-file">ATK3</a>.<h2 id="incomplete-gzip-streams">Incomplete GZip streams</h2><p>There’s this problem of incomplete GZip stream we left aside previously.<p>As a reminder, we are in a situation where we are missing the first 16 bytes of a GZip file. As seen <a href="#keystream-reuse-and-retrieval">above</a>, a GZip file is basically a wrapper around a compressed stream. <a href="https://en.wikipedia.org/wiki/Deflate">DEFLATE</a> is the only one officially supported, according to <a href="https://datatracker.ietf.org/doc/html/rfc1952">RFC 1952</a>. This is also the algorithm used in the files generated by AlphaTav. So, in the end, what we are missing is the beggining of the DEFLATE stream.<p>So let’s take a high-level view at DEFLATE streams:<p><img src="/assets/2022-01-30-decryption-ch/deflate_stream.svg" alt="" class="center-image" /><p>A DEFLATE stream is a <strong>bit</strong>-stream, built around blocks. Each block defines a type of data, which is either raw/uncompressed data, or compressed Huffman data using a static or dynamically computed tree.<p>To still decompress as much data as possible, the general idea is to first find the bit index of the next block, and then decompress the DEFLATE stream starting from this block. Doing this, it is important to note that one block can point to data from the previous blocks, up to 32 kb. If such a thing happens, we generate <em>unknown</em> bytes in the recovered stream. We thus end up with a stream with unknown bytes at the beginning, and this can happen until backtracking only points to known data. This is illustrated in the scheme below:<p><img src="/assets/2022-01-30-decryption-ch/recovered_deflate.svg" alt="" class="center-image" /><p>Finding the bit index of the next block is done by bruteforcing it:<ol><li>we start at bit <code class="language-plaintext highlighter-rouge">X</code> in the DEFLATE stream<li>we launch a full decompression of the stream. If some data are found to be incoherent, add 1 to <code class="language-plaintext highlighter-rouge">X</code> and go to 1.<li>if we found the last block, make sure it is actually the end of the DEFLATE stream. If not, add 1 to <code class="language-plaintext highlighter-rouge">X</code> and go to 1. Otherwise, the position of the next valid block is <code class="language-plaintext highlighter-rouge">X</code>.</ol><p>Doing this, we manage to partially decompress the DEFLATE stream. The only thing we don’t know is how much decompressed data are missing at the beginning. We need this information, otherwise we can’t “align” <code class="language-plaintext highlighter-rouge">ATD</code>, <code class="language-plaintext highlighter-rouge">ATK1</code> and/or <code class="language-plaintext highlighter-rouge">ATK2</code>. Fortunately (again), the GZip format provides, as its four last bytes, the size of the original data (<code class="language-plaintext highlighter-rouge">DecompSize</code>). So, we have exactly <code class="language-plaintext highlighter-rouge">DecompSize-PartialDecompSize</code> unknown bytes at the beginning of the partially decompressed data.<p>To implement this algorithm, we tweaked the excellent <a href="https://www.nayuki.io/page/simple-deflate-decompressor">pure Python DEFLATE implemention by Project Nayuki</a>.<p>In practice, in the tests we’ve done, recovering the index of the next block only takes a few seconds, and we manage to recover around 99.9% of the decompressed data.<h1 id="cracking-the-challenge">Cracking the challenge</h1><p><a href="#the-challenge-material">As said previously</a>, the challenge is an AlphaTav container. On the 2019-10-11, Ex0-Sys published the last (<code class="language-plaintext highlighter-rouge">ATK3</code>) of the four files (<code class="language-plaintext highlighter-rouge">ATD</code>, <code class="language-plaintext highlighter-rouge">ATK1</code>, <code class="language-plaintext highlighter-rouge">ATK2</code>, <code class="language-plaintext highlighter-rouge">ATK3</code>), allowing us to launch our attack.<p>In this case, <code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code>/<code class="language-plaintext highlighter-rouge">ATK2</code> are encrypted with, respectively, RC2/3DES/3DES. We are thus lucky enough not to have to deal with the <a href="#incomplete-gzip-streams">partial GZip stream issue</a>. Moreover, as the container is 460MB, we had plenty of known bits to play with, and the keystream is successfully retreived in less than a minute (what actually takes of the time is decrypting and decompressing the <code class="language-plaintext highlighter-rouge">AT*</code> files in Python).<p>Once cracked, we are left with a zip file that contains a video to claim the bounty, and another AlphaTav container named <code class="language-plaintext highlighter-rouge">Bounty Challenge BTC Wallet.at{d,k1,k2,k3}</code>.<h2 id="bonus-container-with-the-electrum-wallet">Bonus: container with the Electrum wallet</h2><p>Cracking the previous container was enough to claim the bounty, but we were curious about this new container. Here, <code class="language-plaintext highlighter-rouge">ATD</code>/<code class="language-plaintext highlighter-rouge">ATK1</code>/<code class="language-plaintext highlighter-rouge">ATK2</code> are encrypted with, respectively, AES256/AES256/3DES. We have thus to deal with the <a href="#incomplete-gzip-stream">partial GZip stream issue</a>. Fortunately, our partial decompression algorithm allows us to recover 99.9% of <code class="language-plaintext highlighter-rouge">ATD</code> and <code class="language-plaintext highlighter-rouge">ATK1</code>, giving plenty of data to run our keystream recovery attack.<p>After cracking the container, we are left with an <a href="https://electrum.org/">electrum</a> wallet, whose passphrase is unknown to us (at that time).<h1 id="conclusion">Conclusion</h1><p>As stated in the title of this article, this somehow looked like a CTF, as for every step of the algorithm there was always something possible to achieve to move to the next one (e.g. having reliable clear text values thanks to the zip format, being able to still retrieve partial DEFLATE streams, etc). The core of the attack is the reuse of a fixed keystream to XOR various data, and everything we do in the attack is about finding known clear/encrypted data to recover that keystream. As a side note, we also haven’t seen any integrity checks in the container, but might have missed it.<p>The Ex0-sys team was professional in handling their bounty program. They had the real desire to improve their technology. That being said, I think this proves once again that cryptosystem designs should be open and their implementation easily reviewable by everyone. The only secrets should be various key materials.<p>Kerckhoff was right, once again.<h1 id="timeline">Timeline</h1><ul><li>2019-10-11: challenge broken in the morning (publication of the ATK3 file), sending of the proof by mail<li>2019-10-11: acknowledgment by the ex0-sys team<li>2019-10-13: sending of a PoC that decrypts the challenge<li>2019-10-16: acknowledgment that the PoC works. ex0-sys also provides the wallet password.<li>2019-10-21: authorization to present this work at a private conference in Paris<li>[…]: procrastinating this blog post<li>2021-01-30: publication of this blog post</ul><h1 id="acknowledgments">Acknowledgments</h1><p>I would like to thank <a href="https://twitter.com/angealbertini">Ange Albertini</a> for providing the very nice Zip and GZip file format description images.<p>Also thanks to toffan, patate &amp; acid for reviewing this blog post!<div class="footnotes" role="doc-endnotes"><ol><li id="fn:1"><p><a href="https://en.wikipedia.org/wiki/Kerckhoffs%27s_principle">Kerckhoff</a> might not agree on calling this encryption. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a><li id="fn:2"><p>Kerckhoff is happier with this one <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></ol></div></article><hr class="dingbat related mb6" /><aside class="related mb4" role="complementary"><h2 class="hr-bottom">Related Posts</h2><ul class="related-posts"><li class="h4"> <a href="/blog/2020/11/22/donjon-ctf-sssgx.html" class="flip-title"><span>Donjon CTF SSSGX write-up: linear functions strike back</span></a> <time class="faded fine" datetime="2020-11-22T00:00:00+01:00">22 Nov 2020</time><li class="h4"> <a href="/blog/2020/10/05/dragonffi-library-lifting.html" class="flip-title"><span>Lifting shared libraries & PIE binaries with DragonFFI (and LIEF)</span></a> <time class="faded fine" datetime="2020-10-05T00:00:00+02:00">05 Oct 2020</time><li class="h4"> <a href="/blog/2020/08/29/miasm-bootloader.html" class="flip-title"><span>Emulating NotPetya bootloader with Miasm</span></a> <time class="faded fine" datetime="2020-08-29T00:00:00+02:00">29 Aug 2020</time></ul></aside><footer class="content" role="contentinfo"><hr/><p><small class="copyright">© 2024. All rights reserved. </small><p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">9.2.1</span></small><hr class="sr-only"/></footer></main><hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg " style="background-color:rgb(0,0,0);"></div><div class="sidebar-sticky"><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_drawer--opened" href="/blog/" class="sidebar-nav-item " > Blog </a><li> <a href="/software/" class="sidebar-nav-item " > Software </a><li> <a href="/pubs/" class="sidebar-nav-item " > Publications </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social</span><ul><li> <a href="https://twitter.com/adriengnt" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/aguinet" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>(()=>{var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())})(); </script> <script src="/assets/js/hydejack-9.2.1.js" type="module"></script> <script src="/assets/js/LEGACY-hydejack-9.2.1.js" nomodule defer></script> <!--<![endif]--><div hidden><h2 class="sr-only">Templates:</h2><template id="_animation-template"><div class="animation-main fixed-top"><nav id="breadcrumbs" class="screen-only"><ul></ul></nav><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template"><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template"><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading: <a class="this-link" href=""></a>.</div></template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template></div></html>
